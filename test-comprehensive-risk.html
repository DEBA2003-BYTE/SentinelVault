<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Risk Assessment Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input, select { padding: 8px; margin: 5px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .risk-factor { display: flex; justify-content: space-between; padding: 8px; margin: 4px 0; border-radius: 4px; }
        .risk-low { background-color: #d4edda; }
        .risk-medium { background-color: #fff3cd; }
        .risk-high { background-color: #f8d7da; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <h1>üîí Comprehensive Risk Assessment System Test</h1>
    <p>This page tests the 10-factor OPA-based risk assessment system with detailed explanations.</p>

    <div class="test-section">
        <h3>Step 1: Register Test User (if needed)</h3>
        <input type="email" id="regEmail" placeholder="Email" value="risktest@example.com">
        <input type="password" id="regPassword" placeholder="Password" value="password123">
        <button onclick="registerUser()">Register User</button>
        <div id="registerResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Configure Risk Factors</h3>
        <div class="form-grid">
            <div>
                <h4>Device & Location</h4>
                <label>Device Fingerprint:</label>
                <select id="deviceType">
                    <option value="same">Same Device (0 points)</option>
                    <option value="new">New Device (+20 points)</option>
                </select><br>
                
                <label>Location:</label>
                <select id="locationType">
                    <option value="same">Same Location (0 points)</option>
                    <option value="city">New City (+10 points)</option>
                    <option value="country">New Country (+15 points)</option>
                </select><br>
                
                <label>Network:</label>
                <select id="networkType">
                    <option value="clean">Clean IP (0 points)</option>
                    <option value="suspicious">Suspicious IP (+7 points)</option>
                    <option value="vpn">VPN/Tor (+10 points)</option>
                </select>
            </div>
            
            <div>
                <h4>Behavioral Factors</h4>
                <label>Failed Attempts:</label>
                <select id="failedAttempts">
                    <option value="0">0 attempts (0 points)</option>
                    <option value="1">1 attempt (+4 points)</option>
                    <option value="2">2 attempts (+8 points)</option>
                    <option value="3">3+ attempts (+15 points)</option>
                </select><br>
                
                <label>Typing Speed Variance:</label>
                <select id="typingVariance">
                    <option value="0">Normal (<15% - 0 points)</option>
                    <option value="5">Medium (15-30% - +5 points)</option>
                    <option value="10">High (>30% - +10 points)</option>
                </select><br>
                
                <label>Login Time:</label>
                <select id="loginTime">
                    <option value="normal">Normal Hours (0 points)</option>
                    <option value="unusual">Outside Hours (+10 points)</option>
                </select>
            </div>
        </div>
        
        <div style="margin-top: 15px;">
            <h4>Additional Factors</h4>
            <label>Browser/OS:</label>
            <select id="browserType">
                <option value="same">Same Browser (0 points)</option>
                <option value="new">New Browser (+10 points)</option>
            </select>
            
            <label>Behavioral Score:</label>
            <select id="behavioralScore">
                <option value="0">Normal (0 points)</option>
                <option value="10">Unusual (+10 points)</option>
            </select>
            
            <label>Account Age:</label>
            <select id="accountAge">
                <option value="old">Old Account (0 points)</option>
                <option value="new">New Account (+5 points)</option>
            </select>
            
            <label>Recent Activity:</label>
            <select id="recentActivity">
                <option value="normal">Normal (0 points)</option>
                <option value="high">High Activity (+5 points)</option>
            </select>
        </div>
    </div>

    <div class="test-section">
        <h3>Step 3: Test Risk Assessment</h3>
        <button onclick="testRiskAssessment()" style="background: #007bff; color: white; padding: 15px 30px; font-size: 16px;">
            üßÆ Calculate Risk Score
        </button>
        <div id="riskResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Risk Factor Breakdown</h3>
        <div id="riskBreakdown"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let authToken = '';

        async function registerUser() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password,
                        deviceFingerprint: 'registered-device-12345',
                        location: 'New York, NY, USA'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('registerResult').innerHTML = 
                        `<div class="success">‚úÖ User registered successfully!</div>`;
                } else {
                    document.getElementById('registerResult').innerHTML = 
                        `<div class="error">‚ùå Registration failed: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('registerResult').innerHTML = 
                    `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        async function testRiskAssessment() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            // Build risk factors based on selections
            const riskFactors = {
                deviceFingerprint: document.getElementById('deviceType').value === 'new' ? 'new-device-67890' : 'registered-device-12345',
                location: getLocationByType(document.getElementById('locationType').value),
                failedAttempts: parseInt(document.getElementById('failedAttempts').value),
                typingSpeed: getTypingSpeed(),
                networkType: document.getElementById('networkType').value,
                browserType: document.getElementById('browserType').value,
                behavioralScore: parseInt(document.getElementById('behavioralScore').value),
                accountAge: document.getElementById('accountAge').value,
                recentActivity: document.getElementById('recentActivity').value,
                loginTime: document.getElementById('loginTime').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/auth/login-comprehensive`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        deviceFingerprint: riskFactors.deviceFingerprint,
                        location: riskFactors.location,
                        typingSpeed: riskFactors.typingSpeed,
                        keystrokes: generateMockKeystrokes()
                    })
                });
                
                const result = await response.json();
                displayRiskResult(result, response.status);
                
            } catch (error) {
                document.getElementById('riskResult').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function getLocationByType(type) {
            switch(type) {
                case 'same': return 'New York, NY, USA';
                case 'city': return 'Boston, MA, USA';
                case 'country': return 'London, UK';
                default: return 'New York, NY, USA';
            }
        }

        function getTypingSpeed() {
            const variance = document.getElementById('typingVariance').value;
            const baseline = 40; // WPM
            switch(variance) {
                case '0': return baseline + 2; // Normal variance
                case '5': return baseline + 8; // 20% variance
                case '10': return baseline + 15; // 35% variance
                default: return baseline;
            }
        }

        function generateMockKeystrokes() {
            const keystrokes = [];
            const startTime = Date.now();
            const keys = ['p', 'a', 's', 's', 'w', 'o', 'r', 'd', '1', '2', '3'];
            
            keys.forEach((key, index) => {
                keystrokes.push({
                    timestamp: startTime + (index * 100), // 100ms between keystrokes
                    key: key
                });
            });
            
            return keystrokes;
        }

        function displayRiskResult(result, status) {
            let statusClass = 'success';
            let statusText = '‚úÖ Access Granted';
            
            if (status === 403) {
                statusClass = 'error';
                statusText = 'üö´ Access Denied';
            } else if (status === 202) {
                statusClass = 'warning';
                statusText = '‚ö†Ô∏è MFA Required';
            }
            
            const riskAssessment = result.risk_assessment;
            
            document.getElementById('riskResult').innerHTML = `
                <div class="${statusClass}">
                    <h4>${statusText}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div>
                            <strong>Risk Score:</strong><br>
                            <span style="font-size: 24px; color: ${getRiskColor(riskAssessment.risk_level)}">
                                ${riskAssessment.risk_score}/100
                            </span>
                        </div>
                        <div>
                            <strong>Risk Level:</strong><br>
                            <span style="color: ${getRiskColor(riskAssessment.risk_level)}; text-transform: uppercase; font-weight: bold;">
                                ${riskAssessment.risk_level}
                            </span>
                        </div>
                        <div>
                            <strong>Action:</strong><br>
                            ${riskAssessment.suggested_action}
                        </div>
                    </div>
                    
                    ${riskAssessment.reasons.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>Risk Factors Detected:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                ${riskAssessment.reasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">View Full Response</summary>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            displayRiskBreakdown(riskAssessment);
        }

        function displayRiskBreakdown(assessment) {
            const factors = [
                { name: 'Device Fingerprint', weight: 20, description: 'Device recognition status' },
                { name: 'Location Anomaly', weight: 15, description: 'Geographic location verification' },
                { name: 'Login Time', weight: 10, description: 'Time of access attempt' },
                { name: 'Typing Speed', weight: 10, description: 'Keystroke pattern analysis' },
                { name: 'Failed Attempts', weight: 15, description: 'Previous login failures' },
                { name: 'Browser/OS', weight: 10, description: 'Browser and OS fingerprint' },
                { name: 'Network Reputation', weight: 10, description: 'IP address reputation' },
                { name: 'Behavioral Pattern', weight: 10, description: 'Navigation behavior' },
                { name: 'Account Age', weight: 5, description: 'Time since account creation' },
                { name: 'Recent Activity', weight: 5, description: 'Login frequency analysis' }
            ];
            
            let breakdownHtml = `
                <h4>üìä Risk Factor Analysis (Total: ${assessment.risk_score}/100)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            `;
            
            factors.forEach(factor => {
                const isTriggered = assessment.reasons.some(reason => 
                    reason.toLowerCase().includes(factor.name.toLowerCase().split(' ')[0])
                );
                const score = isTriggered ? factor.weight : 0;
                const riskClass = score > 10 ? 'risk-high' : score > 0 ? 'risk-medium' : 'risk-low';
                
                breakdownHtml += `
                    <div class="risk-factor ${riskClass}">
                        <div>
                            <strong>${factor.name}</strong><br>
                            <small>${factor.description}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>+${score}</strong><br>
                            <small>/${factor.weight}</small>
                        </div>
                    </div>
                `;
            });
            
            breakdownHtml += '</div>';
            
            // Add thresholds explanation
            breakdownHtml += `
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h5>üéØ Risk Thresholds:</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="risk-low" style="padding: 10px; text-align: center; border-radius: 5px;">
                            <strong>0-30 Points</strong><br>
                            <span style="color: #155724;">Low Risk</span><br>
                            <small>Grant full access</small>
                        </div>
                        <div class="risk-medium" style="padding: 10px; text-align: center; border-radius: 5px;">
                            <strong>31-70 Points</strong><br>
                            <span style="color: #856404;">Medium Risk</span><br>
                            <small>Require MFA</small>
                        </div>
                        <div class="risk-high" style="padding: 10px; text-align: center; border-radius: 5px;">
                            <strong>71-100 Points</strong><br>
                            <span style="color: #721c24;">High Risk</span><br>
                            <small>Block access</small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('riskBreakdown').innerHTML = breakdownHtml;
        }

        function getRiskColor(level) {
            switch(level) {
                case 'low': return '#28a745';
                case 'medium': return '#ffc107';
                case 'high': return '#dc3545';
                default: return '#6c757d';
            }
        }
    </script>
</body>
</html>