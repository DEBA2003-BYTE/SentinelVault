<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîê Registration Flow Test</h1>
    <p>This page tests the automatic device fingerprint and location detection during registration.</p>

    <div class="test-section">
        <h3>Step 1: Generate Device Context</h3>
        <button onclick="generateDeviceContext()">Generate Device Fingerprint & Location</button>
        <div id="deviceContextResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Test Registration</h3>
        <input type="email" id="testEmail" placeholder="Test Email" value="autotest@example.com">
        <input type="password" id="testPassword" placeholder="Test Password" value="password123">
        <button onclick="testRegistration()">Test Registration</button>
        <div id="registrationResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Verify Login Works</h3>
        <button onclick="testLogin()">Test Login WITHOUT Device Context (Auto-Generate)</button>
        <button onclick="testLoginWithContext()">Test Login WITH Device Context</button>
        <div id="loginResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let deviceContext = null;

        // Device fingerprinting function (copied from the actual implementation)
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Canvas fingerprinting
            if (ctx) {
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
            }
            const canvasFingerprint = canvas.toDataURL();

            // Screen information
            const screen = {
                width: window.screen.width,
                height: window.screen.height,
                colorDepth: window.screen.colorDepth,
                pixelDepth: window.screen.pixelDepth
            };

            // Navigator information
            const navigator = {
                userAgent: window.navigator.userAgent,
                language: window.navigator.language,
                platform: window.navigator.platform,
                cookieEnabled: window.navigator.cookieEnabled,
                doNotTrack: window.navigator.doNotTrack,
                hardwareConcurrency: window.navigator.hardwareConcurrency || 0
            };

            // Timezone
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

            // Combine all fingerprint data
            const fingerprintData = {
                canvas: canvasFingerprint.slice(-50), // Last 50 chars to reduce size
                screen,
                navigator,
                timezone,
                timestamp: Date.now()
            };

            // Generate hash-like fingerprint
            const fingerprint = btoa(JSON.stringify(fingerprintData))
                .replace(/[^a-zA-Z0-9]/g, '')
                .slice(0, 32);

            return fingerprint;
        }

        async function getLocationInfo() {
            try {
                // Try to get location from IP geolocation service
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return `${data.city}, ${data.region}, ${data.country_name}`;
            } catch (error) {
                console.log('Geolocation failed, using fallback');
                return 'Unknown Location';
            }
        }

        async function generateDeviceContext() {
            try {
                const fingerprint = generateDeviceFingerprint();
                const location = await getLocationInfo();
                
                deviceContext = {
                    fingerprint,
                    location,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    clientInfo: {
                        screenResolution: `${screen.width}x${screen.height}`,
                        colorDepth: screen.colorDepth,
                        pixelRatio: window.devicePixelRatio,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        platform: navigator.platform,
                        language: navigator.language,
                        cookieEnabled: navigator.cookieEnabled,
                        doNotTrack: navigator.doNotTrack || 'unspecified'
                    }
                };

                document.getElementById('deviceContextResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Device Context Generated</h4>
                        <p><strong>Fingerprint:</strong> ${deviceContext.fingerprint}</p>
                        <p><strong>Location:</strong> ${deviceContext.location}</p>
                        <p><strong>User Agent:</strong> ${deviceContext.userAgent.substring(0, 50)}...</p>
                        <details>
                            <summary>Full Device Context</summary>
                            <pre>${JSON.stringify(deviceContext, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } catch (error) {
                document.getElementById('deviceContextResult').innerHTML = 
                    `<div class="error">‚ùå Error generating device context: ${error.message}</div>`;
            }
        }

        async function testRegistration() {
            if (!deviceContext) {
                alert('Please generate device context first');
                return;
            }

            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                const payload = {
                    email,
                    password,
                    deviceFingerprint: deviceContext.fingerprint,
                    location: deviceContext.location
                };

                console.log('Registration payload:', payload);

                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('registrationResult').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Registration Successful!</h4>
                            <p><strong>User ID:</strong> ${result.user.id}</p>
                            <p><strong>Email:</strong> ${result.user.email}</p>
                            <p><strong>Token:</strong> ${result.token.substring(0, 20)}...</p>
                            <details>
                                <summary>Full Response</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    
                    // Store token for login test
                    localStorage.setItem('testToken', result.token);
                } else {
                    document.getElementById('registrationResult').innerHTML = `
                        <div class="error">
                            <h4>‚ùå Registration Failed</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${result.error}</p>
                            <p><strong>Message:</strong> ${result.message || 'No additional message'}</p>
                            <details>
                                <summary>Full Response</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('registrationResult').innerHTML = 
                    `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                // Test login WITHOUT device context to verify auto-generation
                const payload = {
                    email,
                    password
                    // Intentionally NOT including deviceFingerprint and location
                    // to test automatic generation
                };

                console.log('Login payload (without device context):', payload);

                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('loginResult').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Login Successful!</h4>
                            <p><strong>User ID:</strong> ${result.user.id}</p>
                            <p><strong>Email:</strong> ${result.user.email}</p>
                            <p><strong>Device Recognized:</strong> ${result.deviceInfo?.isRecognized ? 'Yes' : 'No'}</p>
                            <p><strong>Risk Score:</strong> ${result.riskScore || 'N/A'}</p>
                            <details>
                                <summary>Full Response</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    document.getElementById('loginResult').innerHTML = `
                        <div class="error">
                            <h4>‚ùå Login Failed</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${result.error}</p>
                            <p><strong>Message:</strong> ${result.message || 'No additional message'}</p>
                            <details>
                                <summary>Full Response</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        async function testLoginWithContext() {
            if (!deviceContext) {
                alert('Please generate device context first');
                return;
            }

            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            try {
                const payload = {
                    email,
                    password,
                    deviceFingerprint: deviceContext.fingerprint,
                    location: deviceContext.location
                };

                console.log('Login payload (with device context):', payload);

                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('loginResult').innerHTML += `
                        <div class="success">
                            <h4>‚úÖ Login with Context Successful!</h4>
                            <p><strong>User ID:</strong> ${result.user.id}</p>
                            <p><strong>Email:</strong> ${result.user.email}</p>
                            <p><strong>Device Recognized:</strong> ${result.deviceInfo?.isRecognized ? 'Yes' : 'No'}</p>
                            <p><strong>Risk Score:</strong> ${result.riskScore || 'N/A'}</p>
                            <details>
                                <summary>Full Response</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    document.getElementById('loginResult').innerHTML += `
                        <div class="error">
                            <h4>‚ùå Login with Context Failed</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${result.error}</p>
                            <p><strong>Message:</strong> ${result.message || 'No additional message'}</p>
                            <details>
                                <summary>Full Response</summary>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML += 
                    `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        // Auto-generate device context on page load
        window.onload = function() {
            generateDeviceContext();
        };
    </script>
</body>
</html>